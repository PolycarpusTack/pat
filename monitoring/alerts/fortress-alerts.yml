# Fortress Alerting Rules for Production Monitoring
groups:
  # ================================
  # Critical System Alerts
  # ================================
  - name: fortress.critical
    rules:
      # Service availability alerts
      - alert: FortressServiceDown
        expr: up{job=~"fortress-.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: "{{ $labels.job }}"
          team: fortress-oncall
        annotations:
          summary: "Fortress service {{ $labels.job }} is down"
          description: "Service {{ $labels.job }} has been down for more than 1 minute. Instance: {{ $labels.instance }}"
          runbook_url: "https://docs.fortress.example.com/runbooks/service-down"
          dashboard_url: "https://grafana.fortress.example.com/d/fortress-overview"

      # High error rate alert
      - alert: FortressHighErrorRate
        expr: |
          (
            sum(rate(fortress_http_requests_total{status=~"5.."}[5m])) by (service)
            /
            sum(rate(fortress_http_requests_total[5m])) by (service)
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          team: fortress-oncall
        annotations:
          summary: "High error rate in {{ $labels.service }}"
          description: "Error rate is {{ $value | humanizePercentage }} for service {{ $labels.service }}"
          runbook_url: "https://docs.fortress.example.com/runbooks/high-error-rate"

      # Database connection issues
      - alert: FortressDatabaseConnectionFailure
        expr: |
          fortress_database_connections_failed_total > 10
        for: 2m
        labels:
          severity: critical
          component: database
          team: fortress-oncall
        annotations:
          summary: "Database connection failures detected"
          description: "{{ $value }} database connection failures in the last 2 minutes"
          runbook_url: "https://docs.fortress.example.com/runbooks/database-issues"

      # SMTP service critical alerts
      - alert: FortressSMTPServiceCritical
        expr: |
          fortress_smtp_connections_active > fortress_smtp_connections_max * 0.9
        for: 3m
        labels:
          severity: critical
          component: smtp
          team: fortress-oncall
        annotations:
          summary: "SMTP service approaching connection limit"
          description: "SMTP connections: {{ $value }} ({{ $labels.instance }})"
          runbook_url: "https://docs.fortress.example.com/runbooks/smtp-overload"

  # ================================
  # High Priority Alerts
  # ================================
  - name: fortress.high
    rules:
      # Response time alerts
      - alert: FortressHighResponseTime
        expr: |
          histogram_quantile(0.95, 
            sum(rate(fortress_http_request_duration_seconds_bucket[5m])) by (le, service)
          ) > 2.0
        for: 5m
        labels:
          severity: high
          team: fortress-dev
        annotations:
          summary: "High response time for {{ $labels.service }}"
          description: "95th percentile response time is {{ $value }}s for {{ $labels.service }}"
          runbook_url: "https://docs.fortress.example.com/runbooks/high-latency"

      # Memory usage alerts
      - alert: FortressHighMemoryUsage
        expr: |
          (
            fortress_memory_usage_bytes / fortress_memory_available_bytes
          ) > 0.85
        for: 10m
        labels:
          severity: high
          component: system
          team: fortress-dev
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"
          runbook_url: "https://docs.fortress.example.com/runbooks/memory-usage"

      # Plugin system alerts
      - alert: FortressPluginFailures
        expr: |
          increase(fortress_plugin_failures_total[15m]) > 5
        for: 0m
        labels:
          severity: high
          component: plugins
          team: fortress-dev
        annotations:
          summary: "Multiple plugin failures detected"
          description: "{{ $value }} plugin failures in the last 15 minutes"
          runbook_url: "https://docs.fortress.example.com/runbooks/plugin-failures"

      # Email processing backlog
      - alert: FortressEmailBacklog
        expr: |
          fortress_email_queue_size > 1000
        for: 10m
        labels:
          severity: high
          component: email-processing
          team: fortress-dev
        annotations:
          summary: "Email processing backlog detected"
          description: "{{ $value }} emails queued for processing"
          runbook_url: "https://docs.fortress.example.com/runbooks/email-backlog"

  # ================================
  # Warning Level Alerts
  # ================================
  - name: fortress.warning
    rules:
      # Disk space warnings
      - alert: FortressDiskSpaceWarning
        expr: |
          (
            fortress_disk_free_bytes / fortress_disk_total_bytes
          ) < 0.15
        for: 15m
        labels:
          severity: warning
          component: system
          team: fortress-ops
        annotations:
          summary: "Low disk space on {{ $labels.instance }}"
          description: "Disk space is {{ $value | humanizePercentage }} full on {{ $labels.instance }}"
          runbook_url: "https://docs.fortress.example.com/runbooks/disk-space"

      # CPU usage warnings
      - alert: FortressHighCPUUsage
        expr: |
          100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 15m
        labels:
          severity: warning
          component: system
          team: fortress-ops
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value }}% on {{ $labels.instance }}"
          runbook_url: "https://docs.fortress.example.com/runbooks/cpu-usage"

      # Redis connection warnings
      - alert: FortressRedisHighConnections
        expr: |
          redis_connected_clients > 80
        for: 5m
        labels:
          severity: warning
          component: redis
          team: fortress-ops
        annotations:
          summary: "High Redis connection count"
          description: "Redis has {{ $value }} connected clients"
          runbook_url: "https://docs.fortress.example.com/runbooks/redis-connections"

      # Plugin performance warnings
      - alert: FortressSlowPluginExecution
        expr: |
          histogram_quantile(0.95,
            sum(rate(fortress_plugin_execution_duration_seconds_bucket[10m])) by (le, plugin_id)
          ) > 5.0
        for: 10m
        labels:
          severity: warning
          component: plugins
          team: fortress-dev
        annotations:
          summary: "Slow plugin execution: {{ $labels.plugin_id }}"
          description: "Plugin {{ $labels.plugin_id }} 95th percentile execution time: {{ $value }}s"
          runbook_url: "https://docs.fortress.example.com/runbooks/slow-plugins"

  # ================================
  # Business Logic Alerts
  # ================================
  - name: fortress.business
    rules:
      # Email volume anomalies
      - alert: FortressUnusualEmailVolume
        expr: |
          abs(
            rate(fortress_emails_received_total[1h]) -
            avg_over_time(rate(fortress_emails_received_total[1h])[7d:1h])
          ) > 
          2 * stddev_over_time(rate(fortress_emails_received_total[1h])[7d:1h])
        for: 30m
        labels:
          severity: warning
          component: email-processing
          team: fortress-business
        annotations:
          summary: "Unusual email volume detected"
          description: "Current email rate: {{ $value }} emails/sec (anomaly detected)"
          runbook_url: "https://docs.fortress.example.com/runbooks/email-anomalies"

      # Tenant usage spikes
      - alert: FortressTenantUsageSpike
        expr: |
          increase(fortress_tenant_emails_total[1h]) >
          avg_over_time(increase(fortress_tenant_emails_total[1h])[7d:]) * 3
        for: 15m
        labels:
          severity: warning
          component: tenant-management
          team: fortress-business
        annotations:
          summary: "Usage spike for tenant {{ $labels.tenant_id }}"
          description: "Tenant {{ $labels.tenant_id }} email volume: {{ $value }} in last hour"
          runbook_url: "https://docs.fortress.example.com/runbooks/tenant-spikes"

      # Failed email delivery rate
      - alert: FortressHighDeliveryFailureRate
        expr: |
          (
            sum(rate(fortress_emails_failed_total[15m]))
            /
            sum(rate(fortress_emails_total[15m]))
          ) > 0.1
        for: 10m
        labels:
          severity: warning
          component: email-delivery
          team: fortress-ops
        annotations:
          summary: "High email delivery failure rate"
          description: "Email delivery failure rate: {{ $value | humanizePercentage }}"
          runbook_url: "https://docs.fortress.example.com/runbooks/delivery-failures"

  # ================================
  # Security Alerts
  # ================================
  - name: fortress.security
    rules:
      # Authentication failure spikes
      - alert: FortressAuthFailureSpike
        expr: |
          increase(fortress_auth_failures_total[5m]) > 20
        for: 1m
        labels:
          severity: high
          component: authentication
          team: fortress-security
        annotations:
          summary: "Authentication failure spike detected"
          description: "{{ $value }} authentication failures in 5 minutes from {{ $labels.source_ip }}"
          runbook_url: "https://docs.fortress.example.com/runbooks/auth-failures"

      # Rate limiting triggered
      - alert: FortressRateLimitingTriggered
        expr: |
          increase(fortress_rate_limit_triggered_total[10m]) > 50
        for: 2m
        labels:
          severity: warning
          component: rate-limiting
          team: fortress-security
        annotations:
          summary: "Rate limiting frequently triggered"
          description: "Rate limiting triggered {{ $value }} times in 10 minutes"
          runbook_url: "https://docs.fortress.example.com/runbooks/rate-limiting"

      # Suspicious IP activity
      - alert: FortressSuspiciousIPActivity
        expr: |
          fortress_security_suspicious_ips_active > 0
        for: 0m
        labels:
          severity: high
          component: security
          team: fortress-security
        annotations:
          summary: "Suspicious IP activity detected"
          description: "{{ $value }} suspicious IPs currently active"
          runbook_url: "https://docs.fortress.example.com/runbooks/suspicious-ips"

      # TLS certificate expiration
      - alert: FortressTLSCertificateExpiring
        expr: |
          (fortress_tls_certificate_expiry_seconds - time()) / 86400 < 30
        for: 1h
        labels:
          severity: warning
          component: tls
          team: fortress-ops
        annotations:
          summary: "TLS certificate expiring soon"
          description: "TLS certificate for {{ $labels.domain }} expires in {{ $value }} days"
          runbook_url: "https://docs.fortress.example.com/runbooks/tls-renewal"

  # ================================
  # Infrastructure Alerts
  # ================================
  - name: fortress.infrastructure
    rules:
      # PostgreSQL alerts
      - alert: FortressPostgreSQLSlowQueries
        expr: |
          pg_stat_database_blk_read_time / pg_stat_database_blks_read > 10
        for: 5m
        labels:
          severity: warning
          component: postgresql
          team: fortress-ops
        annotations:
          summary: "PostgreSQL slow queries detected"
          description: "Average read time per block: {{ $value }}ms"
          runbook_url: "https://docs.fortress.example.com/runbooks/postgresql-performance"

      - alert: FortressPostgreSQLHighConnections
        expr: |
          pg_stat_activity_count > 80
        for: 5m
        labels:
          severity: warning
          component: postgresql
          team: fortress-ops
        annotations:
          summary: "High PostgreSQL connection count"
          description: "{{ $value }} active PostgreSQL connections"
          runbook_url: "https://docs.fortress.example.com/runbooks/postgresql-connections"

      # Redis alerts
      - alert: FortressRedisHighMemoryUsage
        expr: |
          redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          component: redis
          team: fortress-ops
        annotations:
          summary: "High Redis memory usage"
          description: "Redis memory usage: {{ $value | humanizePercentage }}"
          runbook_url: "https://docs.fortress.example.com/runbooks/redis-memory"

      - alert: FortressRedisSlowLog
        expr: |
          increase(redis_slowlog_length[10m]) > 0
        for: 0m
        labels:
          severity: warning
          component: redis
          team: fortress-ops
        annotations:
          summary: "Redis slow queries detected"
          description: "{{ $value }} slow queries logged in last 10 minutes"
          runbook_url: "https://docs.fortress.example.com/runbooks/redis-slowlog"

  # ================================
  # Synthetic Monitoring Alerts
  # ================================
  - name: fortress.synthetic
    rules:
      # Health check failures
      - alert: FortressHealthCheckFailed
        expr: |
          probe_success{job="blackbox-http"} == 0
        for: 2m
        labels:
          severity: high
          component: synthetic-monitoring
          team: fortress-oncall
        annotations:
          summary: "Health check failed for {{ $labels.instance }}"
          description: "Health check probe failed for {{ $labels.instance }}"
          runbook_url: "https://docs.fortress.example.com/runbooks/health-check-failures"

      # SSL certificate monitoring
      - alert: FortressSSLCertificateInvalid
        expr: |
          probe_ssl_earliest_cert_expiry - time() < 86400 * 7
        for: 1h
        labels:
          severity: warning
          component: ssl-monitoring
          team: fortress-ops
        annotations:
          summary: "SSL certificate expiring for {{ $labels.instance }}"
          description: "SSL certificate expires in {{ $value | humanizeDuration }}"
          runbook_url: "https://docs.fortress.example.com/runbooks/ssl-certificate-renewal"